<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Gateway - Servers (Test)</title>
    <!-- Google Font Link (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- End Google Font Link -->
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <style>
        /* Keyframes for spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* -- Theme Color Variables -- */
        :root {
            --bg-color: #f8f9fa; /* Light background */
            --text-color: #212529; /* Dark text */
            --card-bg: #ffffff; /* White cards */
            --card-border: #dee2e6; /* Keep border color */
            --header-bg: #e9ecef;
            --sidebar-bg: var(--bg-color); /* Match main background */
            --button-bg: #0d6efd; /* Primary button */
            --button-text: #ffffff;
            --secondary-button-bg: #6c757d; /* Gray secondary */
            --secondary-button-text: #ffffff;
            --link-color: #0d6efd;
            --badge-bg: #6c757d;
            --badge-text: #ffffff;
            --official-badge-bg: #0d6efd;
            --official-badge-text: #ffffff;
            --input-bg: #ffffff;
            --input-text: #212529;
            --input-placeholder: #6c757d;
            /* Theme Toggle Button Colors - Light Mode */
            --toggle-button-bg: #ffffff; /* White background */
            --toggle-button-text: #212529; /* Dark icon */
            --toggle-button-border: #dee2e6; /* Light border */
            /* Add more variables as needed */
        }

        html.dark-mode {
            --bg-color: #212529; /* Dark background */
            --text-color: #f8f9fa; /* Light text */
            --card-bg: #343a40; /* Darker cards */
            --card-border: #495057;
            --header-bg: #495057;
            --sidebar-bg: var(--bg-color); /* Match main background */
            --button-bg: #0d6efd; /* Keep primary button */
            --button-text: #ffffff;
            --secondary-button-bg: #6c757d; /* Keep secondary button gray */
            --secondary-button-text: #ffffff;
            --link-color: #6ea8fe; /* Lighter blue link */
            --badge-bg: #adb5bd;
            --badge-text: #212529;
            --official-badge-bg: #6ea8fe; /* Lighter blue official */
            --official-badge-text: #212529; /* Dark text on light blue */
            --input-bg: #495057;
            --input-text: #f8f9fa;
            --input-placeholder: #adb5bd;
            /* Theme Toggle Button Colors - Dark Mode */
            --toggle-button-bg: #495057; /* Dark background (matches header) */
            --toggle-button-text: #f8f9fa; /* Light icon */
            --toggle-button-border: #6c757d; /* Darker border */
        }

        /* Apply variables */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6; /* Improve readability */
        }
        .main-header {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--card-border); /* Add subtle border */
            /* Assuming header text color is inherited or set in style.css */
        }
        .sidebar {
             background-color: var(--sidebar-bg);
             color: var(--text-color); /* Ensure sidebar uses main text color */
        }
        .sidebar h3 {
            color: var(--text-color); /* Ensure heading uses text color */
            border-bottom: 1px solid var(--card-border); /* Add separator */
            padding-bottom: 0.5em;
            margin-bottom: 1em;
        }
        .sidebar ul,
        .sidebar ul li,
        .sidebar ul li span,
        .sidebar ul li span:first-child { /* Ensure all sidebar text inherits */
             font-weight: 600; /* Make label slightly bolder */
             color: var(--text-color);
        }
        .sidebar ul li span:last-child {
             /* Assuming the count badge has its own styling */
        }
        .service-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-color); /* Ensure card text uses theme color */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .service-card h2, .service-card .owner, .service-card .description {
             color: var(--text-color); /* Explicitly set text color */
        }
        /* Example for a specific badge if needed */
        .badge {
            background-color: var(--badge-bg);
            color: var(--badge-text);
        }
        .edit-button {
            /* Assuming style.css defines button styles, override if needed */
            /* background-color: var(--button-bg); */
            /* color: var(--button-text); */
        }
        a {
            color: var(--link-color);
        }
        .toggle-label {
            color: var(--text-color);
        }
        .logout-button,
        .search-bar button {
            background-color: var(--secondary-button-bg);
            color: var(--secondary-button-text);
            border: 1px solid var(--secondary-button-bg);
        }
        .edit-button { /* Assuming this is primary */
            background-color: var(--button-bg);
            color: var(--button-text);
            /* Add padding/border etc. if needed from style.css */
        }
        .search-bar input[type="search"] {
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--card-border);
        }
        .search-bar input[type="search"]::placeholder {
            color: var(--input-placeholder);
            opacity: 1; /* Override browser defaults */
        }
        .official-badge {
            background-color: var(--official-badge-bg);
            color: var(--official-badge-text);
            padding: 0.2em 0.6em; /* Add padding if it doesn't have it */
            border-radius: 0.8em; /* Add rounding if it doesn't have it */
            font-size: 0.8em;
            font-weight: bold;
            vertical-align: middle;
        }

        /* Health Status Badge Styles */
        .status-badge {
            border-radius: 0.8em;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            vertical-align: middle;
            white-space: nowrap;
            display: inline-block;
            padding: 0.2em 0.6em;
            line-height: 1.4;
            margin-right: 5px;
        }
        .status-healthy {
            background-color: #28a745; /* Green */
        }
        .status-unhealthy {
            background-color: #dc3545; /* Red */
        }
        .status-error {
            background-color: #6c757d; /* Gray */
        }
        .status-disabled {
            background-color: #adb5bd; /* Lighter Gray */
            color: #333;
        }
        .status-unknown {
            background-color: #adb5bd; /* Lighter Gray */
             color: #333;
        }

        /* Style for the separate spinner */
        .status-spinner {
            /* display: none; /* Hidden by default - Let JS control this */
            width: 1.2em;
            height: 1.2em;
            border: 2px solid rgba(253, 126, 20, 0.3); /* Light orange base border */
            border-top-color: #fd7e14; /* Spinner color (Orange) */
            border-radius: 50%;
            vertical-align: middle;
            display: inline-block; /* Keep inline-block for layout when visible */
            animation: spin 1s linear infinite;
            box-sizing: border-box;
            position: relative; /* Allow relative positioning */
            top: -5px; /* Nudge down slightly (adjust as needed) */
        }

        /* Wrapper for badge and spinner */
        .status-indicator-area {
            display: flex;
            align-items: center; /* Back to center alignment */
            margin-bottom: 10px; /* Space below this area */
            /* height: 2em; */ /* Optional: Set a fixed height for the container? */
        }

        /* Adjust header items container */
        .card-header .header-right-items {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* New style for controls row */
        .card-body .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Push items to ends */
            gap: 15px; /* Space between items if they were closer */
            margin-top: 15px; /* Add some space above this row */
        }

        /* Ensure toggle form doesn't take extra space */
        .card-body .toggle-form {
            margin: 0; /* Remove default margins if any */
        }

        /* Style for the moved status badge */
        .card-body .status-badge {
            display: inline-block; /* Allow margin */
            margin-bottom: 10px; /* Space below badge */
        }

        /* Ensure main title uses text color */
        .content h1 {
            color: var(--text-color);
        }

        /* --- Theme Toggle Button --- */
        .theme-toggle-button {
            cursor: pointer;
            font-size: 1.1em; /* Make icon smaller */
            background: none; /* Transparent background */
            border: none; /* No border */
            color: var(--text-color); /* Use main text color for icon */
            padding: 0; /* Remove padding */
            margin-left: 10px; /* Add some space */
            position: relative; /* Allow nudging */
            top: -2px; /* Nudge up slightly (adjust px value if needed) */
        }

        /* Ensure header right items are vertically centered */
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px; /* Adjust spacing as needed */
        }

        /* Explicit alignment for non-button items */
        .header-right .user-display {
            vertical-align: middle;
        }

        /* Ensure form aligns correctly in flex context */
        .header-right form {
             margin: 0; /* Remove default form margin */
             padding: 0; /* Remove default form padding */
             display: inline-block; /* Treat form like an inline block */
             vertical-align: middle;
        }

        /* --- Tool List Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 20px 30px;
            border-radius: 8px;
            min-width: 300px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
            line-height: 1;
        }
        .modal-close-button:hover {
            opacity: 0.7;
        }
        #tool-modal-list-container ul {
            list-style: disc;
            padding-left: 20px;
            margin-top: 10px;
        }
        #tool-modal-list-container li {
            margin-bottom: 5px;
        }
        /* --- Style for clickable tool icon --- */
        .clickable-tool-icon {
            cursor: pointer;
            text-decoration: none; /* Remove underline if wrapped in <a> */
        }
        .clickable-tool-icon:hover {
             opacity: 0.8;
        }

        /* --- Sidebar Toggle Styles --- */
        .header-left {
            display: flex;
            align-items: center;
        }
        .sidebar-toggle-button {
            /* Remove absolute positioning styles */
            /* position: absolute; */
            /* top: 10px; */
            /* right: 10px; */
            /* z-index: 10; */
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5em; /* Adjust size */
            cursor: pointer;
            /* Restore original padding/margin */
            padding: 0 10px;
            margin-right: 10px;
        }
        .sidebar-toggle-button:hover {
            opacity: 0.7;
        }

        /* Collapsible Sidebar Styles */
        .sidebar {
            /* Remove relative positioning */
            /* position: relative; */
            width: 250px; /* Standard width */
            transition: width 0.3s ease, padding 0.3s ease;
            overflow-x: hidden; /* Prevent horizontal scrollbar during transition */
            padding: 20px;
            flex-shrink: 0; /* Prevent sidebar from shrinking smaller than width */
        }
        .content {
            flex-grow: 1;
            margin-left: 20px; /* Standard margin */
            transition: margin-left 0.3s ease;
            overflow-y: auto; /* Allow content to scroll independently */
            padding-bottom: 20px; /* Ensure space at bottom */
        }
        /* Styles when collapsed */
        body.sidebar-collapsed .sidebar {
            width: 0; /* Collapse completely */
            padding: 20px 0; /* Collapse padding horizontally */
        }
        body.sidebar-collapsed .content {
            margin-left: 0; /* No margin when sidebar is 0 width */
        }
        /* Hide sidebar content */
        body.sidebar-collapsed .sidebar > * {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s 0.3s, opacity 0.3s ease; /* Delay hiding until width transition ends */
        }
        /* Make sidebar content visible again when expanded */
        .sidebar > * {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s ease 0.1s; /* Fade in slightly delayed */
        }

        /* --- New Sidebar Content Styles --- */
        .sidebar-section {
            margin-bottom: 2em;
        }
        .sidebar-section h3 {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--input-placeholder); /* Use subtle color for heading */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.8em;
            padding-left: 10px; /* Align with links */
        }
        .sidebar-nav ul,
        .sidebar-stats {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-nav li,
        .sidebar-stats li {
            margin-bottom: 0.5em;
        }
        .sidebar-link {
            display: block;
            color: var(--text-color);
            text-decoration: none;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.95em;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .sidebar-link:hover {
            background-color: var(--card-bg); /* Subtle hover */
            color: var(--link-color); /* Highlight on hover */
        }
        .sidebar-link.active-filter {
            background-color: rgba(13, 110, 253, 0.1); /* Light primary background for active */
            color: var(--link-color);
            font-weight: 600;
        }
        .sidebar-stats li {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: var(--text-color);
            padding: 4px 10px;
        }
        .sidebar-stats span:first-child {
            color: var(--input-placeholder); /* Dim label */
        }
        .sidebar-stats span:last-child {
            font-weight: 600;
        }
    </style>
    <script>
        // Immediately invoked function to apply theme before rendering
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            // Default to dark if no preference saved
            const theme = savedTheme || (prefersDark ? 'dark' : 'dark');

            console.log('[HEAD SCRIPT] Determined initial theme:', theme);

            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
                console.log('[HEAD SCRIPT] Applied dark-mode class.');
            } else {
                document.documentElement.classList.remove('dark-mode');
                console.log('[HEAD SCRIPT] Ensured dark-mode class removed.');
            }
        })();

        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            // Initial timestamp update based on data-* attributes set by Jinja
            updateAllTimestamps();
            // Set interval to update timestamps periodically
            // setInterval(updateAllTimestamps, 5000); // REMOVED periodic update
        });

        function formatTimeAgoJS(isoString) {
            if (!isoString) {
                console.log('[formatTimeAgoJS] Input is null/empty, returning "Never"');
                return "Never";
            }
            console.log(`[formatTimeAgoJS] Formatting: ${isoString}`);
            try {
                const dt = new Date(isoString);
                // Check if the date is valid after parsing
                if (isNaN(dt.getTime())) {
                    console.error(`[formatTimeAgoJS] Invalid Date parsed from: ${isoString}`);
                    return "Invalid date";
                }

                const now = new Date();
                const diff = now.getTime() - dt.getTime(); // Difference in milliseconds

                const seconds = Math.floor(diff / 1000);
                if (seconds < 2) return "Just now";
                if (seconds < 60) return `${seconds}s ago`;

                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m ago`;

                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h ago`;

                const days = Math.floor(hours / 24);
                return `${days}d ago`;
            } catch (e) {
                console.error("Error parsing date:", isoString, e);
                return "Invalid date";
            }
        }

        function updateAllTimestamps() {
            document.querySelectorAll('.metadata[data-timestamp]').forEach(el => {
                const isoString = el.dataset.timestamp;
                const timeAgoEl = el.querySelector('.time-ago');
                if (timeAgoEl) {
                    const formattedTime = formatTimeAgoJS(isoString);
                    // console.log(`[updateAllTimestamps] Updating ${el.id || 'element'} with data ${isoString} to: ${formattedTime}`);
                    timeAgoEl.textContent = formattedTime;
                } else {
                    console.error('[updateAllTimestamps] Could not find .time-ago span within', el);
                }
            });
        }

        // Combined update function
        function updateServiceDisplay(badgeId, spinnerId, lastCheckedId, serviceData) {
            const badge = document.getElementById(badgeId);
            const spinner = document.getElementById(spinnerId);
            const lastCheckedEl = document.getElementById(lastCheckedId);
            // --- Get num_tools element ID --- START
            const safePath = badgeId.replace('status-badge-', ''); // Derive safePath from badgeId
            const numToolsId = 'num-tools-' + safePath;
            const numToolsEl = document.getElementById(numToolsId);
            // --- Get num_tools element ID --- END

            console.log(`Updating display for ${badgeId}. Data:`, serviceData);

            if (!badge || !spinner || !lastCheckedEl) {
                console.error(`Missing elements for ${badgeId}. Badge: ${!!badge}, Spinner: ${!!spinner}, Timestamp: ${!!lastCheckedEl}`);
                return;
            }
            // --- Also check if numToolsEl exists --- START
            if (!numToolsEl) {
                console.error(`Missing num_tools element with ID: ${numToolsId}`);
                // Decide if you want to return here or continue updating other parts
            }
            // --- Also check if numToolsEl exists --- END

            const status = serviceData.status;
            const lastCheckedIso = serviceData.last_checked_iso; // Use ISO key
            const numTools = serviceData.num_tools; // --- Get num_tools from data --- START

            // Update last checked time first
            console.log(`[updateServiceDisplay] Received lastCheckedIso: ${lastCheckedIso} for ${lastCheckedId}`);
            // Store the raw timestamp on the element
            lastCheckedEl.dataset.timestamp = lastCheckedIso || '';

            // Update displayed text immediately using the new JS formatter
            const timeAgoEl = lastCheckedEl.querySelector('.time-ago');
            if (timeAgoEl) {
                const formattedTime = formatTimeAgoJS(lastCheckedIso);
                console.log(`[updateServiceDisplay] Attempting to set .time-ago text for ${lastCheckedId} to: ${formattedTime}`); // Log before setting
                timeAgoEl.textContent = formattedTime;
                // Add log immediately after setting to verify
                console.log(`[updateServiceDisplay] AFTER SET: textContent of ${lastCheckedId}'s .time-ago span is now:`, timeAgoEl.textContent);
            } else {
                console.error('[updateServiceDisplay] Could not find .time-ago span within', lastCheckedEl);
            }

            // --- Update Num Tools Display --- START
            if (numToolsEl && numTools !== undefined && numTools !== null) {
                numToolsEl.textContent = `üîß ${numTools}`;
            }
            // --- Update Num Tools Display --- END
        }

        // --- Tool Modal Functions --- START
        // Variables will be fetched inside the functions when needed

        async function showToolModal(servicePath, serviceName) {
            // Fetch elements when the function is called
            const toolModal = document.getElementById('tool-modal');
            const toolModalTitle = document.getElementById('tool-modal-title');
            const toolModalListContainer = document.getElementById('tool-modal-list-container');

            if (!toolModal || !toolModalTitle || !toolModalListContainer) {
                console.error("Tool modal elements not found!");
                return;
            }

            // Update title and show loading state
            toolModalTitle.textContent = `Tools for ${serviceName}`;
            toolModalListContainer.innerHTML = '<p>Loading...</p>';
            toolModal.style.display = 'flex';

            try {
                // Ensure servicePath starts with /
                const apiPath = servicePath.startsWith('/') ? servicePath : '/' + servicePath;
                const response = await fetch(`/api/tools${apiPath}`);

                toolModalListContainer.innerHTML = ''; // Clear loading/previous content

                if (!response.ok) {
                    let errorMsg = `Error fetching tools: ${response.status} ${response.statusText}`;
                    try {
                         // Try to get more specific error from backend JSON
                         const errorData = await response.json();
                         errorMsg = errorData.detail || errorMsg;
                    } catch(e) { /* Ignore if response wasn't JSON */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                const tools = data.tools; // Expecting list of objects

                if (tools && tools.length > 0) {
                    // Instead of ul, use a div container for more structure
                    // const ul = document.createElement('ul');
                    tools.forEach(tool => {
                        const toolDiv = document.createElement('div');
                        toolDiv.style.marginBottom = '15px'; // Add spacing between tools
                        toolDiv.style.borderBottom = '1px solid var(--card-border)'; // Separator
                        toolDiv.style.paddingBottom = '10px';

                        const nameEl = document.createElement('h4');
                        nameEl.textContent = tool.name || 'Unnamed Tool';
                        nameEl.style.marginTop = '0';
                        nameEl.style.marginBottom = '5px';
                        toolDiv.appendChild(nameEl);

                        if (tool.description) {
                            const descEl = document.createElement('p');
                            descEl.textContent = tool.description;
                            descEl.style.fontSize = '0.9em';
                            descEl.style.marginBottom = '8px';
                            toolDiv.appendChild(descEl);
                        }

                        // --- Render Parsed Description --- START
                        if (tool.parsed_description) {
                            const mainDescEl = document.createElement('p');
                            mainDescEl.textContent = tool.parsed_description.main || 'No description available.';
                            mainDescEl.style.whiteSpace = 'pre-wrap'; // Respect newlines in main description
                            toolDiv.appendChild(mainDescEl);

                            if (tool.parsed_description.args) {
                                const argsTitle = document.createElement('strong');
                                argsTitle.textContent = 'Args:';
                                argsTitle.style.display = 'block';
                                argsTitle.style.marginTop = '8px';
                                toolDiv.appendChild(argsTitle);
                                const argsPre = document.createElement('pre');
                                argsPre.textContent = tool.parsed_description.args;
                                argsPre.style.marginLeft = '10px';
                                argsPre.style.marginTop = '3px';
                                argsPre.style.whiteSpace = 'pre-wrap';
                                argsPre.style.fontSize = '0.9em';
                                toolDiv.appendChild(argsPre);
                            }
                            if (tool.parsed_description.returns) {
                                const returnsTitle = document.createElement('strong');
                                returnsTitle.textContent = 'Returns:';
                                returnsTitle.style.display = 'block';
                                returnsTitle.style.marginTop = '8px';
                                toolDiv.appendChild(returnsTitle);
                                const returnsPre = document.createElement('pre');
                                returnsPre.textContent = tool.parsed_description.returns;
                                returnsPre.style.marginLeft = '10px';
                                returnsPre.style.marginTop = '3px';
                                returnsPre.style.whiteSpace = 'pre-wrap';
                                returnsPre.style.fontSize = '0.9em';
                                toolDiv.appendChild(returnsPre);
                            }
                            if (tool.parsed_description.raises) {
                                const raisesTitle = document.createElement('strong');
                                raisesTitle.textContent = 'Raises:';
                                raisesTitle.style.display = 'block';
                                raisesTitle.style.marginTop = '8px';
                                toolDiv.appendChild(raisesTitle);
                                const raisesPre = document.createElement('pre');
                                raisesPre.textContent = tool.parsed_description.raises;
                                raisesPre.style.marginLeft = '10px';
                                raisesPre.style.marginTop = '3px';
                                raisesPre.style.whiteSpace = 'pre-wrap';
                                raisesPre.style.fontSize = '0.9em';
                                toolDiv.appendChild(raisesPre);
                            }
                        } else if (tool.description) { // Fallback to raw description if parsing failed or wasn't applicable
                            const descEl = document.createElement('p');
                            descEl.textContent = tool.description;
                            descEl.style.marginBottom = '8px';
                            toolDiv.appendChild(descEl);
                        }
                        // --- Render Parsed Description --- END

                        if (tool.schema && typeof tool.schema === 'object' && Object.keys(tool.schema).length > 0) {
                            const schemaContainer = document.createElement('div');
                            schemaContainer.style.marginTop = '10px';

                            const schemaTitle = document.createElement('strong');
                            schemaTitle.textContent = 'Input Schema:';
                            schemaContainer.appendChild(schemaTitle);

                            const properties = tool.schema.properties;
                            const required = tool.schema.required || [];

                            if (properties && typeof properties === 'object' && Object.keys(properties).length > 0) {
                                const propsList = document.createElement('div'); // Use div instead of ul
                                propsList.style.marginLeft = '15px';
                                propsList.style.marginTop = '5px';
                                propsList.style.borderLeft = '2px solid var(--card-border)';
                                propsList.style.paddingLeft = '10px';

                                for (const [propName, propDetails] of Object.entries(properties)) {
                                    const propDiv = document.createElement('div');
                                    propDiv.style.marginBottom = '8px';

                                    const nameSpan = document.createElement('strong');
                                    nameSpan.textContent = propName;
                                    propDiv.appendChild(nameSpan);

                                    if (required.includes(propName)) {
                                        const requiredSpan = document.createElement('span');
                                        requiredSpan.textContent = ' (required)';
                                        requiredSpan.style.color = '#dc3545'; // Red color for required
                                        requiredSpan.style.fontSize = '0.8em';
                                        requiredSpan.style.marginLeft = '3px';
                                        propDiv.appendChild(requiredSpan);
                                    }

                                    if (propDetails.type) {
                                        const typeSpan = document.createElement('span');
                                        typeSpan.textContent = ` - Type: ${propDetails.type}`;
                                        typeSpan.style.color = 'var(--input-placeholder)'; // Use a subtle color
                                        typeSpan.style.marginLeft = '5px';
                                        propDiv.appendChild(typeSpan);
                                    }

                                    if (propDetails.description) {
                                        const descP = document.createElement('p');
                                        descP.textContent = propDetails.description;
                                        descP.style.margin = '3px 0 0 10px';
                                        descP.style.fontSize = '0.85em';
                                        propDiv.appendChild(descP);
                                    }

                                    if (propDetails.default !== undefined) {
                                        const defaultP = document.createElement('p');
                                        defaultP.textContent = `Default: ${JSON.stringify(propDetails.default)}`;
                                        defaultP.style.margin = '3px 0 0 10px';
                                        defaultP.style.fontSize = '0.85em';
                                        defaultP.style.color = 'var(--input-placeholder)';
                                        propDiv.appendChild(defaultP);
                                    }

                                    // Add more details like enum, items, etc. if needed

                                    propsList.appendChild(propDiv);
                                }
                                schemaContainer.appendChild(propsList);
                            } else {
                                const noParams = document.createElement('p');
                                noParams.textContent = 'No input parameters defined.';
                                noParams.style.marginLeft = '15px';
                                noParams.style.fontStyle = 'italic';
                                schemaContainer.appendChild(noParams);
                            }

                            // Optionally display $defs if present
                            if (tool.schema.$defs && Object.keys(tool.schema.$defs).length > 0) {
                                const defsContainer = document.createElement('div');
                                defsContainer.style.marginTop = '10px';
                                defsContainer.innerHTML = '<strong>Definitions:</strong> (Schema uses shared definitions not fully displayed here)';
                                defsContainer.style.fontSize = '0.8em';
                                defsContainer.style.color = 'var(--input-placeholder)';
                                schemaContainer.appendChild(defsContainer);
                            }

                            toolDiv.appendChild(schemaContainer);
                        } else if (tool.schema && Object.keys(tool.schema).length === 0){
                             // Handle case where schema is an empty object {}
                            const schemaContainer = document.createElement('div');
                            schemaContainer.style.marginTop = '10px';
                            schemaContainer.innerHTML = '<strong>Input Schema:</strong> No parameters defined.';
                            schemaContainer.style.fontStyle = 'italic';
                            toolDiv.appendChild(schemaContainer);
                        }
                        // Remove the old <pre><code> block logic
                        /*
                        if (tool.schema && typeof tool.schema === 'object' && Object.keys(tool.schema).length > 0) {
                            // ... existing <pre><code> block ...
                        }
                        */
                        toolModalListContainer.appendChild(toolDiv);
                    });
                    // toolModalListContainer.appendChild(ul);
                } else {
                    toolModalListContainer.innerHTML = '<p>No tools listed for this service.</p>';
                }

            } catch (error) {
                console.error("Failed to fetch or display tools:", error);
                toolModalListContainer.innerHTML = `<p style="color: red;">Could not load tools: ${error.message}</p>`;
            }
        }

        function closeToolModal() {
            // Fetch elements when the function is called
            const toolModal = document.getElementById('tool-modal');
            const toolModalListContainer = document.getElementById('tool-modal-list-container'); // Also needed here if clearing content

            if (toolModal) {
                toolModal.style.display = 'none';
                // Optional: Clear content when closing
                if (toolModalListContainer) {
                    toolModalListContainer.innerHTML = '';
                }
            }
        }

        // Add event listener for closing modal on overlay click in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // --- Sidebar Toggle Logic --- START
            const sidebarToggleButton = document.getElementById('sidebar-toggle');
            const bodyElement = document.body;
            const sidebarStateKey = 'sidebarCollapsed';

            // Check localStorage for saved state
            if (localStorage.getItem(sidebarStateKey) === 'true') {
                bodyElement.classList.add('sidebar-collapsed');
            }

            if (sidebarToggleButton) {
                sidebarToggleButton.addEventListener('click', () => {
                    bodyElement.classList.toggle('sidebar-collapsed');
                    // Save current state to localStorage
                    const isCollapsed = bodyElement.classList.contains('sidebar-collapsed');
                    localStorage.setItem(sidebarStateKey, isCollapsed);
                    console.log(`Sidebar toggled. Collapsed: ${isCollapsed}`);
                });
            }
            // --- Sidebar Toggle Logic --- END

            // Ensure all functions above are defined before calling them
            connectWebSocket();
            updateAllTimestamps(); // Initial format based on Jinja render

            const toolModalOverlay = document.getElementById('tool-modal');
            if (toolModalOverlay) {
                 toolModalOverlay.addEventListener('click', function(event) {
                    // Check if the click was directly on the overlay (event.target)
                    // and not on the content area (modal-content) or its children
                    if (event.target === toolModalOverlay) {
                        closeToolModal();
                    }
                });
            }
        });
        // --- Tool Modal Functions --- END

        // --- Toggle Click Handler --- START
        function handleToggleClick(checkboxElement, servicePath) {
             console.log(`Toggle clicked for path: ${servicePath}`);
             // Construct spinner ID
             const safePath = servicePath.replace(/\//g, '_').replace(/:/g, '_');
             const spinnerId = 'spinner-for-' + safePath;
             const spinner = document.getElementById(spinnerId);

             // Show spinner immediately
             if (spinner) {
                 console.log(`Showing spinner ${spinnerId} on toggle click.`);
                 spinner.style.display = 'inline-block';
             } else {
                 console.warn(`Spinner element not found for ID: ${spinnerId}`);
             }

             // Submit the form to trigger backend action
             checkboxElement.form.submit();
        }
        // --- Toggle Click Handler --- END

        function connectWebSocket() {
            // ... (rest of connectWebSocket function) ...
        }

        // --- Update Sidebar Statistics --- START
        function updateSidebarStats(currentServiceDataMap) {
            // Log the received map for debugging
            // console.log('[updateSidebarStats] Called with map:', JSON.parse(JSON.stringify(currentServiceDataMap)));

            const statEnabled = document.getElementById('stat-enabled');
            const statDisabled = document.getElementById('stat-disabled');
            const statIssues = document.getElementById('stat-issues');
            const statTotal = document.getElementById('stat-total');

            if (!statEnabled || !statDisabled || !statIssues || !statTotal) {
                console.warn("Sidebar stat elements not found.");
                return;
            }

            let enabledCount = 0;
            let disabledCount = 0;
            let issuesCount = 0;

            // Initialize or update the global map used for calculation
            if (typeof window.currentHealthStatusMap === 'undefined') {
                window.currentHealthStatusMap = {}; // Initialize if first time
            }
            Object.assign(window.currentHealthStatusMap, currentServiceDataMap);
            // console.log('[updateSidebarStats] Full status map after merge:', JSON.parse(JSON.stringify(window.currentHealthStatusMap)));

            // Calculate stats based on the full map
            const servicePaths = Object.keys(window.currentHealthStatusMap);
            statTotal.textContent = servicePaths.length; // Update total count

            for (const path of servicePaths) {
                 const statusData = window.currentHealthStatusMap[path];
                 const status = statusData.status; // Get status string

                 if (status === 'disabled') {
                     disabledCount++;
                 } else {
                     enabledCount++; // Count anything not disabled as enabled
                     if (status.startsWith('error') || status.startsWith('unhealthy')) {
                         issuesCount++;
                     }
                 }
            }
            // console.log(`[updateSidebarStats] Calculated Counts - Enabled: ${enabledCount}, Disabled: ${disabledCount}, Issues: ${issuesCount}`);

            // Update the text content of the stat elements
            statEnabled.textContent = enabledCount;
            statDisabled.textContent = disabledCount;
            statIssues.textContent = issuesCount;
        }
        // --- Update Sidebar Statistics --- END

        // Combined update function
    </script>
</head>
<body>
    <!-- Main Header -->
    <header class="main-header">
        <div class="header-left">
             {# Button Moved Back To Header #}
             <button id="sidebar-toggle" class="sidebar-toggle-button" title="Toggle Sidebar">‚ò∞</button>
            <div class="logo">
                <img src="{{ url_for('static', path='/logo.png') }}" alt="MCP Gateway Logo" height="30"> <!-- Logo Image -->
                <span>MCP Gateway</span>
            </div>
        </div>
        <div class="header-right">
            <button id="theme-toggle" class="theme-toggle-button" title="Toggle Theme">üåô</button>
            <span class="user-display">User: {{ username }}</span>
            <form action="/logout" method="post" style="display: inline;">
                <button type="submit" class="logout-button">Logout</button>
            </form>
        </div>
    </header>

    <!-- Main Container (Sidebar + Content) -->
    <div class="container" id="main-container">
        <!-- Sidebar (Simplified) -->
        <aside class="sidebar" id="sidebar">
            {# Button Moved Inside Sidebar #}
            {# <button id="sidebar-toggle" class="sidebar-toggle-button" title="Toggle Sidebar">‚ò∞</button> #}

            {# --- New Sidebar Content --- START #}
            <div class="sidebar-section">
                <h3>Filters</h3>
                <nav class="sidebar-nav">
                    <ul>
                        <li><a href="/" class="sidebar-link active-filter" data-filter="all">All Servers</a></li>
                        <li><a href="#" class="sidebar-link" data-filter="enabled">Enabled</a></li>
                        <li><a href="#" class="sidebar-link" data-filter="disabled">Disabled</a></li>
                        <li><a href="#" class="sidebar-link" data-filter="issues">With Issues</a></li>
                        {# Add more filters later, e.g., by tag #}
                    </ul>
                </nav>
            </div>

            <div class="sidebar-section">
                 <h3>Statistics</h3>
                 <ul class="sidebar-stats">
                     {# These counts need to be calculated/updated via JS or passed from backend #}
                     <li><span>Total Servers:</span> <span id="stat-total">{{ services | length }}</span></li>
                     <li><span>Enabled:</span> <span id="stat-enabled">?</span></li>
                     <li><span>Disabled:</span> <span id="stat-disabled">?</span></li>
                     <li><span>With Issues:</span> <span id="stat-issues">?</span></li>
                 </ul>
            </div>
            {# --- New Sidebar Content --- END #}

            {# Remove old Status section #}
            {#
            <h3>Status</h3>
             <ul>
                 <li><span>Discovered</span> <span>{{ services | length }}</span></li>
             </ul>
             #}
        </aside>

        <!-- Main Content Area -->
        <main class="content">
            <!-- Page Header Section (Simplified) -->
            <div class="page-header">
                 <h1>MCP Servers</h1>
                <!-- Removed breadcrumbs, description, social icons -->
            </div>

            <!-- Controls Section (Simplified) -->
            <div class="controls-area search-controls">
                <!-- Search Form -->
                <form action="/" method="get" class="search-bar">
                    <input type="search" name="query" placeholder="Search by name or description..." value="{{ request.query_params.get('query', '') }}">
                    <button type="submit">Search</button>
                </form>
            </div>

             <!-- Service Cards Section -->
            <div class="card-container">
                {% if services %}
                    {% for service in services %}
                    <div class="service-card">
                        <div class="card-header">
                            <h2>{{ service.display_name }}</h2>
                            <div class="header-right-items">
                                <span class="official-badge">official</span>
                                <span class="icons">‚òÅÔ∏è üíª üîÑ</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="owner">Path: {{ service.path }}</p>
                            <div class="badges">
                                {% for tag in service.tags %}
                                <span class="badge">{{ tag }}</span>
                                {% endfor %}
                            </div>
                            <p class="description">
                                {{ service.description | default('No description provided.') }}
                            </p>

                            {# --- Moved Status Badge Logic Here --- #}
                            {% set initial_status = service.health_status %}
                            {# Determine initial class and text, avoiding 'checking' text #}
                            {% set status_class = 'status-unknown' %}
                            {% set display_text = 'unknown' %}

                            {% if initial_status == 'healthy' %}
                                {% set status_class = 'status-healthy' %}
                                {% set display_text = 'healthy' %}
                            {% elif initial_status.startswith('unhealthy') %}
                                {% set status_class = 'status-unhealthy' %}
                                {% set display_text = initial_status.split('(')[0].strip() %}
                            {% elif initial_status.startswith('error') %}
                                {% set status_class = 'status-error' %}
                                {% set display_text = initial_status.split('(')[0].strip() %}
                            {% elif initial_status == 'disabled' %}
                                {% set status_class = 'status-disabled' %}
                                {% set display_text = 'disabled' %}
                            {% elif initial_status == 'checking' %}
                                {# If checking initially, display as 'unknown' until first WS update #}
                                {# Spinner will be shown by JS if needed #}
                                {% set status_class = 'status-unknown' %}
                                {% set display_text = 'unknown' %}
                            {% endif %}

                            {# Generate IDs #}
                            {% set badge_id = 'status-badge-' + service.path | replace('/', '_') | replace(':', '_') %}
                            {% set spinner_id = 'spinner-for-' + service.path | replace('/', '_') | replace(':', '_') %}
                            {% set last_checked_id = 'last-checked-' + service.path | replace('/', '_') | replace(':', '_') %}

                            {# Render badge with determined initial text/class #}
                            <div class="status-indicator-area">
                                <span id="{{ badge_id }}" class="status-badge {{ status_class }}" title="{{ initial_status }}">{{ display_text }}</span>
                                {# Always render spinner, hide initially with inline style #}
                                <span id="{{ spinner_id }}" class="status-spinner" style="display: none;"></span>
                            </div>

                            <div class="controls-row">
                                <a href="/edit{{ service.path }}" class="edit-button">Modify</a>
                                <form action="/toggle{{ service.path }}" method="post" class="toggle-form">
                                    <label class="switch">
                                        {# Call new JS function on change #}
                                        <input type="checkbox" name="enabled" value="on" {% if service.is_enabled %}checked{% endif %} onchange="handleToggleClick(this, '{{ service.path }}')">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label">{{ 'Enabled' if service.is_enabled else 'Disabled' }}</span>
                                </form>
                            </div>
                        </div>
                        <div class="card-footer">
                            {% set last_checked_id = 'last-checked-' + service.path | replace('/', '_') | replace(':', '_') %}
                            {# Store ISO timestamp, display initial formatted text inside span #}
                            <span id="{{ last_checked_id }}" class="metadata" data-timestamp="{{ service.last_checked_iso or '' }}">
                                üïí Last checked: <span class="time-ago">Never</span>
                            </span>
                            {% set num_tools_id = 'num-tools-' + service.path | replace('/', '_') | replace(':', '_') %}
                            <span id="{{ num_tools_id }}" class="metadata clickable-tool-icon" onclick="showToolModal('{{ service.path }}', '{{ service.display_name }}')" title="Click to view tools">üîß {{ service.num_tools }}</span>
                            <span class="metadata">‚≠ê {{ service.num_stars }}</span>
                            <div class="platform-icons">
                                 {% if service.is_python %}<span>üêç Python</span>{% endif %}
                                 <span>‚öñÔ∏è {{ service.license }}</span>
                                 <!-- Consider adding OS icons dynamically if needed -->
                                 <span>üêß</span> <span>Ô£ø</span> <span>ü™ü</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No services found matching your query, or none registered. Try rescanning.</p>
                {% endif %}
            </div> <!-- end card-container -->

        </main> <!-- end content -->
    </div> <!-- end container -->

    <!-- Tool List Modal -->
    <div id="tool-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeToolModal()">&times;</span>
            <h3 id="tool-modal-title">Tools for Service</h3>
            <div id="tool-modal-list-container">
                <!-- Tool list will be populated here by JS -->
                <p>Loading...</p>
            </div>
        </div>
    </div>
    <!-- End Tool List Modal -->

    <script>
        // Moved DOMContentLoaded listener to the end of the script block
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure all functions above are defined before calling them
            connectWebSocket();
            updateAllTimestamps(); // Initial format based on Jinja render
            // setInterval(updateAllTimestamps, 5000); // Keep this commented out for now
        });
    </script>

    <!-- Add Theme Toggle Script -->
</body>
</html>